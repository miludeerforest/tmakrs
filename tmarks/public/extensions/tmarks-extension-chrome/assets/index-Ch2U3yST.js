class t extends Error{constructor(t,e,a,s,r){super(e),this.code=t,this.status=a,this.details=s,this.retryAfter=r,this.name="TMarksAPIError"}isAuthError(){return["MISSING_API_KEY","INVALID_API_KEY","INSUFFICIENT_PERMISSIONS"].includes(this.code)}isRateLimitError(){return"RATE_LIMIT_EXCEEDED"===this.code}isNotFoundError(){return"NOT_FOUND"===this.code}isDuplicateError(){return["DUPLICATE_URL","DUPLICATE_TAG"].includes(this.code)}isServerError(){return this.status>=500}}class e{apiKey;baseUrl;rateLimitInfo=null;constructor(t){this.apiKey=t.apiKey,this.baseUrl=t.baseUrl||"https://tmarks.669696.xyz/api"}getRateLimitInfo(){return this.rateLimitInfo}isNearRateLimit(t=.2){return!!this.rateLimitInfo&&this.rateLimitInfo.remaining/this.rateLimitInfo.limit<t}getRateLimitResetTime(){return this.rateLimitInfo?new Date(1e3*this.rateLimitInfo.reset):null}async request(e,a={}){const s=`${this.baseUrl}${e}`,r={"X-API-Key":this.apiKey,"Content-Type":"application/json",...a.headers};try{const e=await fetch(s,{...a,headers:r});if(this.extractRateLimitInfo(e),204===e.status)return;let n;const o=e.headers.get("content-type");if(o&&o.includes("application/json"))n=await e.json();else{const a=await e.text();if(!e.ok)throw new t(401===e.status?"INVALID_API_KEY":"UNKNOWN_ERROR",a||`HTTP ${e.status}: ${e.statusText}`,e.status);try{n=JSON.parse(a)}catch{n={message:a}}}return e.ok||this.handleErrorResponse(e.status,n),n}catch(n){if(n instanceof t)throw n;if(n instanceof TypeError)throw new t("NETWORK_ERROR","Network error: Unable to connect to TMarks API",0,{originalError:n});throw new t("UNKNOWN_ERROR",n instanceof Error?n.message:"Unknown error occurred",0,{originalError:n})}}async get(t,e){const a=e?`?${new URLSearchParams(this.cleanParams(e)).toString()}`:"";return this.request(`${t}${a}`,{method:"GET"})}async post(t,e){return this.request(t,{method:"POST",body:e?JSON.stringify(e):void 0})}async patch(t,e){return this.request(t,{method:"PATCH",body:JSON.stringify(e)})}async delete(t,e){return this.request(t,{method:"DELETE",body:e?JSON.stringify(e):void 0})}extractRateLimitInfo(t){const e=t.headers.get("X-RateLimit-Limit"),a=t.headers.get("X-RateLimit-Remaining"),s=t.headers.get("X-RateLimit-Reset");e&&a&&s&&(this.rateLimitInfo={limit:parseInt(e,10),remaining:parseInt(a,10),reset:parseInt(s,10)})}handleErrorResponse(e,a){let s,r,n="UNKNOWN_ERROR",o="Unknown error occurred";throw a?.error?(n=a.error.code||n,o=a.error.message||o,s=a.error.details,r=a.error.retry_after):"string"==typeof a?o=a:a?.message&&(o=a.message,n=a.code||n),401===e&&"UNKNOWN_ERROR"===n?(n="INVALID_API_KEY",o=o||"Authentication failed"):403===e&&"UNKNOWN_ERROR"===n?(n="INSUFFICIENT_PERMISSIONS",o=o||"Permission denied"):429===e&&"UNKNOWN_ERROR"===n&&(n="RATE_LIMIT_EXCEEDED",o=o||"Rate limit exceeded"),new t(n,o,e,s,r)}cleanParams(t){const e={};for(const[a,s]of Object.entries(t))null!=s&&(e[a]=String(s));return e}}class a extends e{async getBookmarks(t){return this.get("/tab/bookmarks",t)}async createBookmark(t){return this.post("/tab/bookmarks",t)}async getBookmark(t){return this.get(`/tab/bookmarks/${t}`)}async updateBookmark(t,e){return this.patch(`/tab/bookmarks/${t}`,e)}async deleteBookmark(t){return this.delete(`/tab/bookmarks/${t}`)}async getAllBookmarks(t){const e=[];let a=null;do{const s=await this.getBookmarks({...t,page_cursor:a||void 0,page_size:t?.page_size||100});e.push(...s.data.bookmarks),a=s.data.meta.next_cursor}while(a);return e}async getBookmarksByTags(t,e){return this.getBookmarks({...e,tags:t.join(",")})}async searchBookmarks(t,e){return this.getBookmarks({...e,keyword:t})}async getPinnedBookmarks(t){return this.getBookmarks({...t,pinned:!0})}async getArchivedBookmarks(t){return this.getBookmarks({...t,archived:!0})}async pinBookmark(t){return this.updateBookmark(t,{is_pinned:!0})}async unpinBookmark(t){return this.updateBookmark(t,{is_pinned:!1})}async archiveBookmark(t){return this.updateBookmark(t,{is_archived:!0})}async unarchiveBookmark(t){return this.updateBookmark(t,{is_archived:!1})}}class s extends e{async getTags(){return this.get("/tab/tags")}async createTag(t){return this.post("/tab/tags",t)}async getTag(t){return this.get(`/tab/tags/${t}`)}async updateTag(t,e){return this.patch(`/tab/tags/${t}`,e)}async deleteTag(t){return this.delete(`/tab/tags/${t}`)}async findTagByName(t){return(await this.getTags()).data.tags.find(e=>e.name.toLowerCase()===t.toLowerCase())||null}async createTagIfNotExists(t){try{return await this.createTag(t)}catch(e){if("DUPLICATE_TAG"===e.code){const e=await this.findTagByName(t.name);if(e)return{data:{tag:e}}}throw e}}async getTagsByPopularity(){return(await this.getTags()).data.tags.sort((t,e)=>(e.bookmark_count||0)-(t.bookmark_count||0))}async getUnusedTags(){return(await this.getTags()).data.tags.filter(t=>0===(t.bookmark_count||0))}async deleteUnusedTags(){const t=await this.getUnusedTags();let e=0;for(const s of t)try{await this.deleteTag(s.id),e++}catch(a){}return{deleted:e}}async prepareMergeTags(t,e){const[a,s]=await Promise.all([this.getTag(t),this.getTag(e)]);return{sourceTag:a.data.tag,targetTag:s.data.tag}}}class r extends e{async getMe(){return this.get("/tab/me")}async search(t){return this.get("/tab/search",t)}async quickSearch(t){return this.search({q:t,limit:20})}async getStats(){return(await this.getMe()).data.user.stats}async validateApiKey(){try{return await this.getMe(),!0}catch(t){return!1}}}class n extends e{async getTabGroups(t){return this.get("/tab/tab-groups",t)}async createTabGroup(t){return this.post("/tab/tab-groups",t)}async getTabGroup(t){return this.get(`/tab/tab-groups/${t}`)}async updateTabGroup(t,e){return this.patch(`/tab/tab-groups/${t}`,e)}async deleteTabGroup(t){return this.delete(`/tab/tab-groups/${t}`)}async getAllTabGroups(t){const e=[];let a=null;do{const s=await this.getTabGroups({...t,page_cursor:a||void 0,page_size:t?.page_size||100});e.push(...s.data.tab_groups),a=s.data.meta.next_cursor}while(a);return e}}class o extends e{async createSnapshot(t,e){return this.post(`/tab/bookmarks/${t}/snapshots`,e)}async getSnapshots(t){return this.get(`/tab/bookmarks/${t}/snapshots`)}async deleteSnapshot(t,e){return this.delete(`/tab/bookmarks/${t}/snapshots/${e}`)}}class i{bookmarks;tags;user;tabGroups;snapshots;constructor(t){this.bookmarks=new a(t),this.tags=new s(t),this.user=new r(t),this.tabGroups=new n(t),this.snapshots=new o(t)}getRateLimitInfo(){return this.bookmarks.getRateLimitInfo()}}function c(t){return new i(t)}export{c};
